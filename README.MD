# Apollo Backend

Backend REST API para integraÃ§Ã£o com o smart contract QuestManager no Soroban (Stellar).

## ğŸ“‹ Funcionalidades

- **ğŸ” AutenticaÃ§Ã£o Passkey**: Login biomÃ©trico com Kale passkey-kit
- **âš¡ Smart Wallets**: Carteiras inteligentes na Stellar com assinatura via passkey
- **ğŸ“ GestÃ£o de Quests**: Criar, listar, resolver e cancelar quests
- **ğŸ‘¥ GestÃ£o de UsuÃ¡rios**: Registro, elegibilidade e estatÃ­sticas
- **ğŸŒ IntegraÃ§Ã£o Soroban**: ComunicaÃ§Ã£o completa com o smart contract
- **ğŸ”’ AutenticaÃ§Ã£o MÃºltipla**: JWT, Passkeys e Wallet tradicional
- **ğŸ›¡ï¸ Rate Limiting**: ProteÃ§Ã£o contra abuso da API
- **ğŸ“Š Logs Estruturados**: Sistema de logging completo
- **ğŸ’“ Health Checks**: Monitoramento de saÃºde da aplicaÃ§Ã£o

## ğŸ—ï¸ Arquitetura

```
src/
â”œâ”€â”€ config/          # ConfiguraÃ§Ãµes (Soroban, JWT, etc.)
â”œâ”€â”€ controllers/     # LÃ³gica das rotas REST
â”œâ”€â”€ services/        # IntegraÃ§Ã£o com Soroban e lÃ³gica de negÃ³cio
â”œâ”€â”€ models/          # Tipos e interfaces TypeScript
â”œâ”€â”€ routes/          # DefiniÃ§Ã£o das rotas Express
â”œâ”€â”€ utils/           # FunÃ§Ãµes auxiliares (logger, auth, etc.)
â”œâ”€â”€ middleware/      # Middlewares customizados
â””â”€â”€ index.ts         # Entrypoint do servidor
```

## ğŸš€ InstalaÃ§Ã£o e ExecuÃ§Ã£o

### PrÃ©-requisitos

- Node.js 18+ 
- npm ou yarn
- Conta Stellar testnet/mainnet configurada

### 1. InstalaÃ§Ã£o das dependÃªncias

```bash
npm install
```

### 2. ConfiguraÃ§Ã£o do ambiente

Copie o arquivo de exemplo e configure as variÃ¡veis:

```bash
cp .env.example .env
```

Edite o `.env` com suas configuraÃ§Ãµes:

```env
# Stellar/Soroban Configuration
CONTRACT_ID=your_contract_id_here
NETWORK_PASSPHRASE=Test SDF Network ; September 2015
RPC_URL=https://soroban-testnet.stellar.org:443

# Admin Configuration
ADMIN_SECRET=your_admin_secret_key_here
ADMIN_PUBLIC_KEY=your_admin_public_key_here

# JWT Configuration
JWT_SECRET=your-super-secret-jwt-key-here
JWT_EXPIRATION=24h
```

### 3. ExecuÃ§Ã£o

#### Desenvolvimento
```bash
npm run dev
```

#### ProduÃ§Ã£o
```bash
npm run build
npm start
```

## ğŸ“š Rotas da API

### Quests

- `GET /api/v1/quests` - Lista todas as quests ativas
- `GET /api/v1/quests/:id` - Detalhes de uma quest especÃ­fica
- `POST /api/v1/quests` - Cria uma nova quest (admin)
- `POST /api/v1/quests/:id/register` - Registra usuÃ¡rio em uma quest
- `POST /api/v1/quests/:id/eligible` - Marca usuÃ¡rio como elegÃ­vel (admin)
- `POST /api/v1/quests/:id/resolve` - Resolve quest (admin)
- `POST /api/v1/quests/:id/cancel` - Cancela quest (admin)
- `GET /api/v1/quests/:id/participants` - Lista participantes da quest
- `POST /api/v1/quests/:id/distribute` - Distribui prÃªmios (admin)

### UsuÃ¡rios

- `GET /api/v1/users/:address/quests` - Quests do usuÃ¡rio
- `GET /api/v1/users/:address/stats` - EstatÃ­sticas do usuÃ¡rio

### ğŸ” AutenticaÃ§Ã£o Kale Passkey (NOVO!)

- `POST /auth/passkey/register` - Cria wallet com passkey usando Kale
- `POST /auth/passkey/connect` - Conecta a wallet existente com passkey
- `POST /auth/passkey/quest/:id/register` - Registro em quest com passkey
- `POST /auth/passkey/quest/:id/claim-rewards` - Claim de recompensas com passkey
- `GET /auth/signers/:contractId` - Lista signatÃ¡rios de um contrato wallet

### Sistema

- `GET /health` - Health check da aplicaÃ§Ã£o
- `GET /api/v1/info` - InformaÃ§Ãµes da API
- `GET /auth/info` - Info sobre mÃ©todos de autenticaÃ§Ã£o
- `GET /auth/health` - Health check especÃ­fico de autenticaÃ§Ã£o

## ğŸ”§ Exemplos de Uso

### Criar uma Quest (Admin)

```bash
curl -X POST http://localhost:3000/api/v1/quests \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_ADMIN_JWT" \
  -d '{
    "title": "Trading Volume Challenge",
    "description": "Trade minimum $1000 volume on DEX",
    "reward_token": "USDC",
    "reward_amount": "100",
    "max_participants": 50,
    "start_time": 1693843200,
    "end_time": 1694448000,
    "quest_type": "TRADING_VOLUME",
    "conditions": {
      "min_volume": "1000"
    }
  }'
```

### Registrar UsuÃ¡rio em Quest

```bash
curl -X POST http://localhost:3000/api/v1/quests/1/register \
  -H "Content-Type: application/json" \
  -d '{
    "user_address": "GXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX"
  }'
```

### Listar Quests Ativas

```bash
curl http://localhost:3000/api/v1/quests?page=1&limit=10&status=ACTIVE
```

## ğŸ›¡ï¸ SeguranÃ§a

- **AutenticaÃ§Ã£o JWT**: Protege rotas administrativas
- **Rate Limiting**: Previne abuso da API
- **Helmet**: Headers de seguranÃ§a HTTP
- **CORS**: ConfiguraÃ§Ã£o flexÃ­vel de origens
- **ValidaÃ§Ã£o**: ValidaÃ§Ã£o rigorosa de inputs

## ğŸ”§ Scripts DisponÃ­veis

```bash
npm run dev          # Executa em modo desenvolvimento
npm run build        # Compila TypeScript
npm start            # Executa versÃ£o compilada
npm test             # Executa testes
npm run lint         # Executa linting
npm run lint:fix     # Corrige problemas de lint
```

## ğŸ“Š Monitoramento

### Health Check

```bash
curl http://localhost:3000/health
```

Resposta:
```json
{
  "status": "healthy",
  "timestamp": "2024-09-15T10:30:00.000Z",
  "services": {
    "database": true,
    "soroban_rpc": true,
    "contract": true
  },
  "version": "1.0.0"
}
```

## ğŸ§ª Testes

```bash
# Executar todos os testes
npm test

# Executar com coverage
npm run test:coverage

# Executar em modo watch
npm run test:watch
```

## ğŸš¢ Deploy

### Docker (Recomendado)

1. Criar `Dockerfile`:
```dockerfile
FROM node:18-alpine
WORKDIR /app
COPY package*.json ./
RUN npm ci --only=production
COPY dist ./dist
EXPOSE 3000
CMD ["npm", "start"]
```

2. Build e run:
```bash
docker build -t apollo-backend .
docker run -p 3000:3000 --env-file .env apollo-backend
```

### Deploy Tradicional

1. Build da aplicaÃ§Ã£o:
```bash
npm run build
```

2. Upload dos arquivos `dist/`, `package.json` e `.env`

3. Instalar dependÃªncias no servidor:
```bash
npm ci --only=production
```

4. Iniciar aplicaÃ§Ã£o:
```bash
npm start
```

## ğŸ¤ ContribuiÃ§Ã£o

1. Fork do projeto
2. Criar branch (`git checkout -b feature/AmazingFeature`)
3. Commit das mudanÃ§as (`git commit -m 'Add some AmazingFeature'`)
4. Push da branch (`git push origin feature/AmazingFeature`)
5. Abrir Pull Request

## ğŸ“„ LicenÃ§a

Este projeto estÃ¡ licenciado sob a LicenÃ§a MIT - veja o arquivo [LICENSE](LICENSE) para detalhes.

## ğŸ“ Suporte

Para suporte e dÃºvidas:
- Abra uma issue no GitHub
- Entre em contato com a equipe Apollo

---

**Desenvolvido com â¤ï¸ pela equipe Apollo**